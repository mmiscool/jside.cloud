<style>
    ul {
        list-style-type: circle;
        margin-left: 10px;
        padding: 5;
    }

    body {
        width: 100%;
        height: 100%;
        padding: 0px;
        margin: 0px;
    }

    #top {
        float: left;
        width: 100%;
        background-color: rgb(187, 187, 187);
        height: 30px;
        padding: 0px;
        margin: 0px;
    }

    .toolbar-item {
        height: 100%;
        padding: 0px;
        margin: 0px;
        vertical-align: center;
        float: left;
    }

    div {
        float: left;
        padding: 0px;
        margin: 0px;
        border: 0px;
    }

    #bottom {
        width: 100%;
        height: calc(100% - 30px);

    }


    #left {
        float: left;
        overflow: scroll;
        width: 300px;
        height: 100%;
        padding: 0px;
        margin: 0px;


    }

    .right {
        float: left;
        overflow: scroll;
        width: calc(100% - 300px);
        height: 100%;
    }

    #codeEditor {
        width: 100%;
        height: 100%;

    }

    input {
        width: 100px;
    }
</style>


<body>
    <div id="top" style="width:100%;">
        <b class="toolbar-item">Project Name:</b>
        <input class="toolbar-item" id="projectName" type="text">
        <button onclick="saveMyCode()" class="toolbar-item">üíæ</button>
        <button class="toolbar-item">üóã</button>
        <button class="toolbar-item">üóÅ</button>
        <button class="toolbar-item">Stop</button>
        <button onclick='runApp();' class="toolbar-item">go</button>
        <b class="toolbar-item">|---|</b>
        <button class="toolbar-item">GUI Edit</button>
        <button onclick='setEditMode("codeEditor");' class="toolbar-item">Code Edit</button>
        <button class="toolbar-item">CSS Edit</button>

    </div>

    <div id="bottom">
        <div id="left" style="background-color: aqua;">
            <div id="leftList" style="height:50%;overflow: scroll;width:100%;padding: 0px;margin: 0px;background-color: rgb(172, 175, 175);"></div>
            <div style="height:50%;overflow: scroll;width:100%;padding: 0px;margin: 0px;background-color: rgb(119, 190, 190);">
                <h3>Properties editor</h3>
                <hr>
                <input id="editProperties-id" type="text" style="width:calc(100% - 15px);" disabled>
                <div id="editProperties" style="width:100%;text-align: right;"></div>
            </div>

        </div>
        <div class="right" id="right" style="background-color: royalblue;">
            <textarea id="codeEditor" style="width:100%;height:100%;"></textarea>
            <iframe id="appRun" style="width:100%;height:100%;"></iframe>
        </div>

    </div>
</body>

<script>

    //code to enable using tabs in the code editor
    document.getElementById("codeEditor").addEventListener('keydown', this.keyHandler, false);
    function keyHandler(e) {
        var TABKEY = 9;
        if (e.keyCode == TABKEY) {
            this.value += "    ";
            if (e.preventDefault) {
                e.preventDefault();
            }
            return false;
        }
    }

    async function setEditMode(modeToSetTo) {
        document.getElementById("codeEditor").style.display = "none";
        document.getElementById("appRun").style.display = "none";

        document.getElementById(modeToSetTo).style.display = "inline";
    }

    setEditMode("codeEditor");


    async function runApp() {
        //alert(localStorage.getItem(document.getElementById("projectName").value));
        //alert(btoa(localStorage.getItem(document.getElementById("projectName").value)));
        document.getElementById("appRun").src = "../run.html?data=" + btoa(JSON.stringify(data));
        setEditMode("appRun");
    }



</script>

<script>
    async function saveMyCode() {
        localStorage.setItem(document.getElementById("projectName").value,
            JSON.stringify(
                {
                    innerText: "hello world",
                    id: "fun",
                    nodeName: "body",
                    style: "background-color:red;",
                    children: [
                        {
                            innerText: "hello world",
                            id: "mike",
                            nodeName: "input",
                        },
                        {
                            innerText: "hello world",
                            id: "mike1",
                            nodeName: "input",
                        },
                        {
                            innerText: "click me",
                            id: "mybutton",
                            nodeName: "button",
                            onclick: "alert('hello world')",
                        },
                        {
                            innerText: "",
                            id: "fun1",
                            nodeName: "div",
                            style: "background-color:blue;",
                            children: [
                                {
                                    innerText: "lower button",
                                    id: "mybutton0",
                                    nodeName: "button",
                                },
                                {
                                    innerText: "lower button",
                                    id: "mybutton1",
                                    nodeName: "button",
                                },
                                {
                                    innerText: "lower button",
                                    id: "mybutton1",
                                    nodeName: "button",
                                }
                            ]
                        },
                    ],
                }
                , null, 1)
        );
    }

    data = JSON.parse(localStorage.getItem(document.getElementById("projectName").value));




    async function makeSpan(textForSpan, nextObjectNmae) {
        var newSpan = document.createElement("span");
        codeForOnClick = "setPropertiesWindow('data" + nextObjectNmae + "');"
        newSpan.setAttribute("onclick", codeForOnClick);

        var newNodeButton = document.createElement("button");
        newNodeButton.innerText = "+"
        newNodeButton.setAttribute("onclick", `
        if (data` + nextObjectNmae + `.children ==undefined) data` + nextObjectNmae + `.children = [];
        data` + nextObjectNmae + `.children.push(JSON.parse(freshObjecttemplate));

        data` + nextObjectNmae + `.children[data` + nextObjectNmae + `.children.length - 1].id = Date.now();

        updateTheLeftList();
        `);
        newSpan.appendChild(newNodeButton);


        var newNodeButton = document.createElement("button");
        newNodeButton.innerText = "üóë"
        newNodeButton.setAttribute("onclick", `
        delete data` + nextObjectNmae + `;

        updateTheLeftList();
        `);
        newSpan.appendChild(newNodeButton);


        var textLabel = document.createElement("b");
        textLabel.innerText = textForSpan;

        newSpan.appendChild(textLabel);
        return newSpan;
    }


    async function setPropertiesWindow(itemToBeEditied = "") {
        //alert(JSON.stringify(itemToBeEditied));
        document.getElementById("editProperties").innerHTML = "";

        document.getElementById("editProperties-id").value = itemToBeEditied;

        var objectForEdit = eval(itemToBeEditied);

        for (var prop in objectForEdit) {
            var fieldLabel = document.createElement("b");
            var fieldeditThing = document.createElement("input");
            if (prop !== "children") {
                fieldLabel.innerText = prop;
                document.getElementById("editProperties").appendChild(fieldLabel);

                fieldeditThing.value = objectForEdit[prop];
                fieldeditThing.setAttribute("onchange", itemToBeEditied + "." + prop + "= this.value;");


                document.getElementById("editProperties").appendChild(fieldeditThing);

                document.getElementById("editProperties").appendChild(document.createElement("br"));
                //alert(objectForEdit[prop]);
            }
        }
    }



    freshObjecttemplate = JSON.stringify({
        id: "",
        innerText: "",
        nodeName: "div",
        style: "",
    });



    //make some list stuff on the left hand side
    async function makeItem(itemInput, parentObject, baseObjectName = "") {
        console.log(itemInput.id);
        var nextObjectNmae = baseObjectName;
        console.log("base object name", baseObjectName);
        if (Array.isArray(itemInput.children)) {
            var itemToMake = document.createElement("ul");
        } else {
            var itemToMake = document.createElement("li");
            itemToMake.appendChild(
                await makeSpan(
                    itemInput.nodeName + " " + itemInput.id,
                    nextObjectNmae
                ));
        }



        if (Array.isArray(itemInput.children)) {
            var liItemToMake = document.createElement("li");
            liItemToMake.appendChild(
                await makeSpan(
                    itemInput.nodeName + " " + itemInput.id,
                    nextObjectNmae
                ));
            var arrayLocation = 0;
            for (var childItem in itemInput.children) {
                await makeItem(itemInput.children[childItem], itemToMake, nextObjectNmae + ".children[" + arrayLocation + "]");
                arrayLocation++;
            }

            liItemToMake.appendChild(itemToMake);

            await parentObject.appendChild(liItemToMake);
        } else {
            await parentObject.appendChild(itemToMake);
        }

    }


    function updateTheLeftList() {
        newLeftList = document.createElement("ul");

        makeItem(data, newLeftList);

        document.getElementById("leftList").innerHTML = "";
        document.getElementById("leftList").appendChild(newLeftList);
    }

    updateTheLeftList();

</script>